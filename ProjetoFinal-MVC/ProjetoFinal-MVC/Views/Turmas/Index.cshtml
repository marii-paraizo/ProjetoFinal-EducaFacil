@model IEnumerable<ProjetoFinal_MVC.Models.ViewModels.TurmaViewModel>
@using System.Linq
@{
    ViewData["Title"] = "Turmas";
    ViewData["IsFullWidthPage"] = true;
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    var baseApiUrl = "https://localhost:7126/api/Turmas";
}

<div class="container-principal">

    <div class="cabecalho-turmas">
        <h2>Suas turmas</h2>
        <a href="@Url.Action("Cadastrar", "Turmas")" class="btn-adicionar">
            + ADICIONAR TURMA
        </a>
    </div>

    <div class="grid-turmas">
        @if (Model != null && Model.Any())
        {
            @foreach (var turma in Model)
            {
                <div class="card-turma" data-id="@turma.IdTurma" data-nome="@turma.Nome">
                    <div>
                        <h3>@turma.Nome</h3>
                        <p class="ano-letivo">@turma.AnoLetivo</p>
                    </div>
                    <div>
                        <p class="alunos">Alunos: @turma.QuantidadeAlunos</p>
                    </div>
                    <div class="card-acoes">
                        <i class="fas fa-trash-alt btn-lixeira" title="Excluir turma" data-turma-id="@turma.IdTurma"></i>

                        <button class="btn-seta" title="Ver alunos" onclick="window.location.href='@Url.Action("Index", "Alunos", new { idTurma = turma.IdTurma })'">
                            &gt;
                        </button>
                    </div>
                </div>
            }
        }
        else
        {
            <p>Nenhuma turma cadastrada. Clique em "ADICIONAR TURMA" para começar.</p>
        }
    </div>

</div>

<div class="modal-overlay" id="modalExclusao">
    <div class="modal-confirmacao">
        <p>Tem certeza que deseja excluir a turma <span id="nomeTurmaExcluir"></span>?</p>
        <div class="modal-botoes">
            <button id="btn-excluir-confirmar">SIM</button>
            <button id="btn-excluir-cancelar">CANCELAR</button>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const modalOverlay = document.getElementById('modalExclusao');
            const nomeTurmaSpan = document.getElementById('nomeTurmaExcluir');
            const btnConfirmar = document.getElementById('btn-excluir-confirmar');
            const btnCancelar = document.getElementById('btn-excluir-cancelar');
            const baseApiUrl = '@baseApiUrl';
            let turmaIdParaExcluir = null;

            document.querySelectorAll('.btn-lixeira').forEach(btn => {
                btn.addEventListener('click', function (e) {
                    turmaIdParaExcluir = this.getAttribute('data-turma-id');
                    const card = this.closest('.card-turma');
                    const nomeTurma = card.getAttribute('data-nome');

                    nomeTurmaSpan.textContent = nomeTurma;
                    modalOverlay.style.display = 'flex';
                    setTimeout(() => document.querySelector('.modal-confirmacao').classList.add('ativo'), 10);
                });
            });

            function fecharModal() {
                document.querySelector('.modal-confirmacao').classList.remove('ativo');
                setTimeout(() => modalOverlay.style.display = 'none', 300);
                turmaIdParaExcluir = null;
            }

            btnCancelar.addEventListener('click', fecharModal);
            modalOverlay.addEventListener('click', function (e) {
                if (e.target === modalOverlay) {
                    fecharModal();
                }
            });

            btnConfirmar.addEventListener('click', async function () {
                if (turmaIdParaExcluir) {

                    const urlDelete = `${baseApiUrl}/${turmaIdParaExcluir}`;

                    try {
                        const response = await fetch(urlDelete, {
                            method: 'DELETE',
                            headers: { 'Content-Type': 'application/json' }
                        });

                        if (response.ok || response.status === 204) {
                            const cardParaRemover = document.querySelector(`.card-turma[data-id="${turmaIdParaExcluir}"]`);
                            if (cardParaRemover) {
                                cardParaRemover.style.opacity = 0;
                                cardParaRemover.style.transform = 'scale(0.8)';
                                setTimeout(() => {
                                    cardParaRemover.remove();
                                    fecharModal();
                                }, 300);
                            }
                        } else {
                            alert(`Falha ao excluir a turma. A API retornou o código: ${response.status}.`);
                            fecharModal();
                        }
                    } catch (error) {
                        console.error("Erro na requisição DELETE:", error);
                        alert('Erro de conexão com o servidor ao excluir a turma.');
                        fecharModal();
                    }
                }
            });

            const iconePerfil = document.querySelector('.icone-perfil');
            const userInfo = document.getElementById('userInfo');

            if (iconePerfil) {
                iconePerfil.addEventListener('click', () => {
                    userInfo.classList.toggle('ativo');
                });
                document.addEventListener('click', (e) => {
                    if (!iconePerfil.contains(e.target) && !userInfo.contains(e.target)) {
                        userInfo.classList.remove('ativo');
                    }
                });
            }
        });
    </script>
}